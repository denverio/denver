#!/usr/bin/env sh

projectRootPath=$(cd "$(dirname "$0")/../.."; pwd)
# used in .env file
realUser=${SUDO_USER:-$USER}
dockerUser=${DOCKER_ID_USER:-$realUser}
network=${DE_NETWORK_NAME:-$DE_{{constantCase name}}_NETWORK_NAME}

denver_{{snakeCase name}}_printenv() {
  printenv | grep -E '^DE_{{constantCase name}}_'
  echo
}

denver_{{snakeCase name}}_build() {
  local argsMsg="without args"
  [ $# -ne 0 ] && argsMsg="with args $@"

  echo "Building image \
\"${DE_{{constantCase name}}_SCOPE}/${DE_{{constantCase name}}_NAME}\" \
${argsMsg}..."
  echo

  sudo docker build \
    -t ${DE_{{constantCase name}}_SCOPE}/${DE_{{constantCase name}}_NAME} \
    "$@" \
    $projectRootPath

  return 0
}

denver_{{snakeCase name}}_remove() {
  echo "Removing image \
\"${DE_{{constantCase name}}_SCOPE}/${DE_{{constantCase name}}_NAME}\"..."
  echo

  sudo docker image rm \
    -f ${DE_{{constantCase name}}_SCOPE}/${DE_{{constantCase name}}_NAME}

  return 0
}

denver_{{snakeCase name}}_create_network() {
  sudo docker network create \
    --driver bridge \
    ${DE_{{constantCase name}}_NETWORK_NAME} 2> /dev/null && \
    echo "Created network \"${DE_{{constantCase name}}_NETWORK_NAME}\"! Using it..." || \
    echo "Using network \"${DE_{{constantCase name}}_NETWORK_NAME}\"..."

  echo
}

denver_{{snakeCase name}}_run() {
  local cmd=${1:-$DE_{{constantCase name}}_DEFAULT_COMMAND}
  [ $# -ne 0 ] && shift

  local argsMsg="without args"
  [ $# -ne 0 ] && argsMsg="with args $@"

  echo "Running container \
\"${DE_{{constantCase name}}_SCOPE}_${DE_{{constantCase name}}_NAME}\""
  echo "  based on image \
\"${DE_{{constantCase name}}_SCOPE}/${DE_{{constantCase name}}_NAME}\""
  echo "  with command \"${cmd}\" ${argsMsg}..."
  echo

  denver_{{snakeCase name}}_create_network

  sudo docker run \
    -it \
    --rm \
    --name "${DE_{{constantCase name}}_SCOPE}_${DE_{{constantCase name}}_NAME}" \
    --network ${DE_{{constantCase name}}_NETWORK_NAME} \
    -h "denver-${DE_{{constantCase name}}_NAME}" \
    -p ${DE_{{constantCase name}}_SSH_PORT}:22 \
    -v ${DE_{{constantCase name}}_VOLUME_APP}:/app \
    -v ${DE_{{constantCase name}}_VOLUME_WORKSPACE}:/workspace \
    ${DE_{{constantCase name}}_SCOPE}/${DE_{{constantCase name}}_NAME} \
    ${cmd} \
    "$@"

  return 0
}

denver_{{snakeCase name}}_stop() {
  echo "Stopping container \
\""${DE_{{constantCase name}}_SCOPE}_${DE_{{constantCase name}}_NAME}"\"..."
  echo

  sudo docker container stop \
    "${DE_{{constantCase name}}_SCOPE}_${DE_{{constantCase name}}_NAME}"

  return 0
}

denver_{{snakeCase name}}_main() {
  local runner=${1:-"run"}

  if [ -s "$projectRootPath/.env" ] 
  then
    eval $(env "$(cat "$projectRootPath/.env"; env)" | grep -E '^(DE_|DOCKER_)' | sed 's/^/export /')
  fi

  [ "$runner" != 'printenv' ] &&
    denver_{{snakeCase name}}_printenv

  {
    [ $# -ne 0 ] && shift
    denver_{{snakeCase name}}_${runner} "$@" 2>/dev/null
  } || denver_{{snakeCase name}}_run $runner "$@"

  return 0
}
denver_{{snakeCase name}}_main "$@"

